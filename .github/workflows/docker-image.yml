name: Build and Deploy Docker Image

on:
  workflow_dispatch: {}
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: self-hosted  # 로컬 Ubuntu의 actions 계정에서 실행됨

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Build and tag Docker image
      run: |
        docker build --no-cache -t ${{ secrets.DOCKER_HUB_USERNAME }}/kws_be:latest .
        docker tag ${{ secrets.DOCKER_HUB_USERNAME }}/kws_be:latest ${{ secrets.DOCKER_HUB_USERNAME }}/kws_be:latest

    - name: Deploy container locally
      run: |
        IMAGE=${{ secrets.DOCKER_HUB_USERNAME }}/kws_be:latest
        docker stop KWS_BE || true
        docker rm KWS_BE || true
        docker run -d --name KWS_BE -p 25121:8000 $IMAGE
        docker system prune -af
